<!doctype html><html lang=en><head><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV rel=stylesheet><script crossorigin=anonymous defer integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js></script><script onload="renderMathInElement(document.body, {delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '$', right: '$', display: false},
        {left: '\\(', right: '\\)', display: false},
        {left: '\\[', right: '\\]', display: true}
    ]});" crossorigin=anonymous defer integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js></script><link href=https://riasanovsky.me/katex.css rel=stylesheet></head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title> Kani and CUDA </title><link href=self.jpg rel=icon type=image/png><link href="https://riasanovsky.me/ atom.xml" title="Dr. Alex Riasanovsky" rel=alternate type=application/atom+xml><link href=https://riasanovsky.me/main.css media=screen rel=stylesheet><meta name=description><meta name=description><meta content="index, nofollow" name=robots><meta content="Dr. Alex Riasanovsky" property=og:title><meta content=article property=og:type><meta content=self.jpg property=og:image><meta content=self.jpg name=twitter:card><meta content=https://riasanovsky.me/posts/kani-cuda/ property=og:url><meta property=og:description><meta content="Dr. Alex Riasanovsky" property=og:site_name><meta content="default-src 'self' ws://127.0.0.1:1024/; img-src 'self' https://*; script-src 'self'; style-src 'self'; font-src 'self'" http-equiv=Content-Security-Policy><body><header><div class=navbar><div class="nav-title nav-navs"><a class="nav-links home-title" href=https://riasanovsky.me>Dr. Alex Riasanovsky</a></div><nav class="nav-title nav-navs"><a class=nav-links href=/projects> <img alt=Projects height=15 src=/menu_icon/projects.png width=15> Projects</a><a class=nav-links href=/about> <img alt=About height=15 src=/menu_icon/self.jpg width=15> About</a></nav><nav class="socials nav-navs"><a class="nav-links social" rel="noopener noreferrer" href=https://github.com/ariasanovsky/ target=_blank> <img alt=github src=/social_icons/github.svg title=github> </a><a class="nav-links social" rel="noopener noreferrer" href=https://twitter.com/AlexMath0 target=_blank> <img alt=twitter src=/social_icons/twitter.svg title=twitter> </a><label class=theme-switcher for=themeswitch><div class=background></div> <input id=themeswitch type=checkbox> <div class=switch><img alt="theme switch to dark" class=moon src=/menu_icon/moon.png><img alt="theme switch to light" class=sun src=/menu_icon/sun.png></div></label></nav></div></header><div class=content><main><article><div class=title><h2>Kani and CUDA</h2><div class=meta>Posted on <time>2023-05-16</time><div class=post-tags><nav class="nav tags">🏷: <a href=https://riasanovsky.me/tags/kani/>kani</a>   <a href=https://riasanovsky.me/tags/cuda/>cuda</a>   <a href=https://riasanovsky.me/tags/rust/>rust</a>   <a href=https://riasanovsky.me/tags/ptx/>ptx</a>  </nav></div> ||<span> 5 minute read</span></div></div><h1>Table of Contents</h1><ul><li><a href=https://riasanovsky.me/posts/kani-cuda/#cuda-kernels-in-pure-rust>CUDA kernels in pure Rust?!</a><li><a href=https://riasanovsky.me/posts/kani-cuda/#kernel-crate-source-code>Kernel crate source code</a> <ul><li><a href=https://riasanovsky.me/posts/kani-cuda/#emitted-ptx>Emitted PTX</a></ul><li><a href=https://riasanovsky.me/posts/kani-cuda/#kani>Kani</a><li><a href=https://riasanovsky.me/posts/kani-cuda/#next-steps>Next steps</a></ul><section class=body><h2 id=cuda-kernels-in-pure-rust>CUDA kernels in pure Rust?!</h2><p>I've been implementing an <a href=https://github.com/coreylowman/cudarc/issues/143>experimental feature</a> in the <a href=https://github.com/coreylowman/cudarc><code>cudarc</code></a> crate. The goal is to write CUDA kernels in pure Rust to improve portability and safety. It's far from finished.<p>Currently <code>cudarc</code> emits PTX, the CUDA equivalent of assembly, with JIT source code compilation of <code>C</code> code to PTX that is then loaded at runtime:<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> ptx <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">cudarc<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">nvrtc<span class="z-punctuation z-accessor z-rust">::</span></span>compile_ptx<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>
extern <span class="z-constant z-character z-escape z-rust">\"</span>C<span class="z-constant z-character z-escape z-rust">\"</span> __global__ void sin_kernel(float *out, const float *inp, const size_t numel) {
    unsigned int i = blockIdx.x * blockDim.x + threadIdx.x;
    if (i < numel) {
        out[i] = sin(inp[i]);
    }
}<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> and dynamically load it into the device
</span>dev<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">load_ptx</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>ptx<span class="z-punctuation z-separator z-rust">,</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>my_module<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>sin_kernel<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>For Rust PTX emission, I instead use a JIT <em>crate</em> compiler.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> use compile_crate_to_ptx to build kernels in pure Rust
</span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> uses experimental ABI_PTX
</span><span class="z-storage z-type z-rust">let</span> kernel_path<span class="z-punctuation z-separator z-rust">:</span> PathBuf <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>examples/rust-kernel/src/lib.rs<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-storage z-type z-rust">let</span> kernels<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>Ptx<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">PtxCrate<span class="z-punctuation z-accessor z-rust">::</span></span>compile_crate_to_ptx<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span>kernel_path</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-storage z-type z-rust">let</span> kernel<span class="z-punctuation z-separator z-rust">:</span> Ptx <span class="z-keyword z-operator z-assignment z-rust">=</span> kernels<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">first</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
dev<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">load_ptx</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>kernel<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clone</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>rust_kernel<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>square_kernel<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> we can also manage and clean up the build ptx files with a PtxCrate
</span><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> rust_ptx<span class="z-punctuation z-separator z-rust">:</span> PtxCrate <span class="z-keyword z-operator z-assignment z-rust">=</span> kernel_path<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">try_into</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
rust_ptx<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">build_ptx</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-storage z-type z-rust">let</span> _kernel<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span>Ptx <span class="z-keyword z-operator z-assignment z-rust">=</span> rust_ptx<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">peek_kernels</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">first</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>cleaned successfully? <span class="z-constant z-other z-placeholder z-rust">{:?}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> rust_ptx<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clean</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>The development environment is rough. Notice how I used <code>square</code>? I couldn't actually find <code>sin</code>! I'm still learning how to get the linter on board inside the <code>kernel</code> crate.<h2 id=kernel-crate-source-code>Kernel crate source code</h2><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> lib.rs
</span><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#!</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">feature</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">abi_ptx</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> emitting ptx (unstable)
</span><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#!</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">feature</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">stdsimd</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> simd instructions (unstable)
</span><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#!</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">no_std</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>                  <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> CUDA compatibility
</span>
<span class="z-meta z-module z-rust"><span class="z-storage z-type z-module z-rust">mod</span> <span class="z-entity z-name z-module z-rust">device</span><span class="z-punctuation z-terminator z-rust">;</span></span>

<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">core<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">arch<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">nvptx<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-punctuation z-terminator z-rust">;</span>   <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> access to thread id, etc
</span>
<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">panic_handler</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">my_panic</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">_</span>: <span class="z-keyword z-operator z-rust">&</span><span class="z-meta z-path z-rust">core<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">panic<span class="z-punctuation z-accessor z-rust">::</span></span>PanicInfo</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> </span></span><span class="z-keyword z-operator z-logical z-rust">!</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">no_mangle</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-keyword z-other z-rust">extern</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>ptx-kernel<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">square_kernel</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">input</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-rust">*const</span> <span class="z-storage z-type z-rust">f32</span>, <span class="z-variable z-parameter z-rust">output</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-rust">*mut</span> <span class="z-storage z-type z-rust">f32</span>, <span class="z-variable z-parameter z-rust">size</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> https://doc.rust-lang.org/stable/core/arch/nvptx/index.html <span class="z-punctuation z-definition z-comment z-rust">*/</span></span>
    <span class="z-storage z-type z-rust">let</span> thread_id<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">_thread_idx_x</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-rust">let</span> block_id<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">_block_idx_x</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    
    <span class="z-storage z-type z-rust">let</span> block_dim<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">_block_dim_x</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-rust">let</span> grid_dim<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">_grid_dim_x</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    
    <span class="z-storage z-type z-rust">let</span> n_threads <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>block_dim <span class="z-keyword z-operator z-arithmetic z-rust">*</span> grid_dim</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">u64</span><span class="z-punctuation z-terminator z-rust">;</span>
    
    <span class="z-storage z-type z-rust">let</span> thread_index <span class="z-keyword z-operator z-assignment z-rust">=</span> 
        thread_id <span class="z-keyword z-operator z-arithmetic z-rust">+</span> 
        block_id <span class="z-keyword z-operator z-arithmetic z-rust">*</span> block_dim
    <span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-keyword z-control z-rust">if</span> thread_index <span class="z-keyword z-operator z-comparison z-rust"><</span> size <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> value <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">device<span class="z-punctuation z-accessor z-rust">::</span></span>square<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>input<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">offset</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>thread_index <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">isize</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-keyword z-operator z-arithmetic z-rust">*</span>output<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">offset</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>thread_index <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">isize</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> value<span class="z-punctuation z-terminator z-rust">;</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>The <code>panic_handler</code> is for <code>no_std</code> crates. Here it is used to give CUDA devices instructions for when <code>panic</code>s can't be avoided. Branches and panics drag on performance. Avoid them as much as possible.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> device.rs
</span><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#!</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">no_std</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> a no_std fn
</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">square</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">num</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">f32</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">f32</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> your device function implementation
</span>    num <span class="z-keyword z-operator z-arithmetic z-rust">*</span> num
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>We compile as a <code>C</code> dynamic library and emit PTX, targeing <code>nvptx64</code>.<pre class="language-toml z-code" data-lang=toml><code class=language-toml data-lang=toml><span class="z-source z-toml"><span class="z-comment z-line z-number-sign z-toml"><span class="z-punctuation z-definition z-comment z-toml">#</span> Cargo.toml</span>
<span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">package</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
<span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">name</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>rust-kernel<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
<span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">version</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>0.1.0<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
<span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">edition</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>2021<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>

<span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">lib</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
<span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">name</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>kernel<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
<span class="z-comment z-line z-number-sign z-toml"><span class="z-punctuation z-definition z-comment z-toml">#</span> build = "cargo +nightly rustc --lib --target nvptx64-nvidia-cuda --release -- --emit asm"</span>
<span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">crate-type</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-array z-begin z-toml">[</span><span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>cdylib<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-definition z-array z-end z-toml">]</span>
</span></code></pre><h3 id=emitted-ptx>Emitted PTX</h3><p>The PTX itself is pretty clean.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>
</span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Generated by LLVM NVPTX Back-End
</span><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>
</span>
<span class="z-punctuation z-accessor z-dot z-rust">.</span>version <span class="z-constant z-numeric z-float z-rust">6.</span><span class="z-constant z-numeric z-float z-rust">0</span>
<span class="z-punctuation z-accessor z-dot z-rust">.</span>target sm_30
<span class="z-punctuation z-accessor z-dot z-rust">.</span>address_size <span class="z-constant z-numeric z-integer z-decimal z-rust">64</span>

	<span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> .globl	square_kernel
</span>
<span class="z-punctuation z-accessor z-dot z-rust">.</span>visible <span class="z-punctuation z-accessor z-dot z-rust">.</span>entry <span class="z-support z-function z-rust">square_kernel</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
	<span class="z-punctuation z-accessor z-dot z-rust">.</span>param <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u64</span> square_kernel_param_0<span class="z-punctuation z-separator z-rust">,</span>
	<span class="z-punctuation z-accessor z-dot z-rust">.</span>param <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u64</span> square_kernel_param_1<span class="z-punctuation z-separator z-rust">,</span>
	<span class="z-punctuation z-accessor z-dot z-rust">.</span>param <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u32</span> square_kernel_param_2
</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
<span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
	<span class="z-punctuation z-accessor z-dot z-rust">.</span>reg <span class="z-punctuation z-accessor z-dot z-rust">.</span>pred 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span><span class="z-meta z-generic z-rust">p<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>2<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-terminator z-rust">;</span>
	<span class="z-punctuation z-accessor z-dot z-rust">.</span>reg <span class="z-punctuation z-accessor z-dot z-rust">.</span>b32 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span><span class="z-meta z-generic z-rust">r<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>6<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-terminator z-rust">;</span>
	<span class="z-punctuation z-accessor z-dot z-rust">.</span>reg <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">f32</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span><span class="z-meta z-generic z-rust">f<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>3<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-terminator z-rust">;</span>
	<span class="z-punctuation z-accessor z-dot z-rust">.</span>reg <span class="z-punctuation z-accessor z-dot z-rust">.</span>b64 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span><span class="z-meta z-generic z-rust">rd<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>8<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-terminator z-rust">;</span>

	ld<span class="z-punctuation z-accessor z-dot z-rust">.</span>param<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u32</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>r1<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>square_kernel_param_2<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
	mov<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u32</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>r2<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>tid<span class="z-punctuation z-accessor z-dot z-rust">.</span>x<span class="z-punctuation z-terminator z-rust">;</span>
	mov<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u32</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>r3<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>ctaid<span class="z-punctuation z-accessor z-dot z-rust">.</span>x<span class="z-punctuation z-terminator z-rust">;</span>
	mov<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u32</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>r4<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>ntid<span class="z-punctuation z-accessor z-dot z-rust">.</span>x<span class="z-punctuation z-terminator z-rust">;</span>
	mad<span class="z-punctuation z-accessor z-dot z-rust">.</span>lo<span class="z-punctuation z-accessor z-dot z-rust">.</span>s32 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>r5<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>r3<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>r4<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>r2<span class="z-punctuation z-terminator z-rust">;</span>
	setp<span class="z-punctuation z-accessor z-dot z-rust">.</span>lt<span class="z-punctuation z-accessor z-dot z-rust">.</span>s32 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>p1<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>r5<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>r1<span class="z-punctuation z-terminator z-rust">;</span>
	<span class="z-keyword z-operator z-rust">@</span><span class="z-keyword z-operator z-arithmetic z-rust">%</span>p1 bra 	<span class="z-variable z-other z-rust">$L__BB0_2</span><span class="z-punctuation z-terminator z-rust">;</span>
	bra<span class="z-punctuation z-accessor z-dot z-rust">.</span>uni 	<span class="z-variable z-other z-rust">$L__BB0_1</span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-variable z-other z-rust">$L__BB0_2</span><span class="z-punctuation z-separator z-rust">:</span>
	ld<span class="z-punctuation z-accessor z-dot z-rust">.</span>param<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u64</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd3<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>square_kernel_param_0<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
	ld<span class="z-punctuation z-accessor z-dot z-rust">.</span>param<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u64</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd4<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>square_kernel_param_1<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
	cvta<span class="z-punctuation z-accessor z-dot z-rust">.</span>to<span class="z-punctuation z-accessor z-dot z-rust">.</span>global<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u64</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd5<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd4<span class="z-punctuation z-terminator z-rust">;</span>
	cvta<span class="z-punctuation z-accessor z-dot z-rust">.</span>to<span class="z-punctuation z-accessor z-dot z-rust">.</span>global<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">u64</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd6<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd3<span class="z-punctuation z-terminator z-rust">;</span>
	mul<span class="z-punctuation z-accessor z-dot z-rust">.</span>wide<span class="z-punctuation z-accessor z-dot z-rust">.</span>s32 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd7<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>r5<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">4</span><span class="z-punctuation z-terminator z-rust">;</span>
	add<span class="z-punctuation z-accessor z-dot z-rust">.</span>s64 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd1<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd5<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd7<span class="z-punctuation z-terminator z-rust">;</span>
	add<span class="z-punctuation z-accessor z-dot z-rust">.</span>s64 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd2<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd6<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd7<span class="z-punctuation z-terminator z-rust">;</span>
	ld<span class="z-punctuation z-accessor z-dot z-rust">.</span>global<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">f32</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>f1<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd2<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
	mul<span class="z-punctuation z-accessor z-dot z-rust">.</span>rn<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">f32</span> 	<span class="z-keyword z-operator z-arithmetic z-rust">%</span>f2<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>f1<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>f1<span class="z-punctuation z-terminator z-rust">;</span>
	st<span class="z-punctuation z-accessor z-dot z-rust">.</span>global<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-storage z-type z-rust">f32</span> 	<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-keyword z-operator z-arithmetic z-rust">%</span>rd1<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-arithmetic z-rust">%</span>f2<span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-variable z-other z-rust">$L__BB0_1</span><span class="z-punctuation z-separator z-rust">:</span>
	ret<span class="z-punctuation z-terminator z-rust">;</span>

</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>On the other hand, <a href=https://github.com/rust-lang/rust/issues/38788><code>ABI_PTX</code></a> is very much an experiemntal Rust feature. It would be an exciting challenge to work on it some day.<p>As of today, <a href=https://docs.nvidia.com/cuda/parallel-thread-execution/index.html>PTX is on version 8.1</a>, compared to our version 6.0. For simple kernels, perhaps this doesn't matter. But what about <code>sm_30</code>? Read <a href=https://arnon.dk/matching-sm-architectures-arch-and-gencode-for-various-nvidia-cards/>here</a> to learn more about the architecture names. I don't think it's a good sign to see <code>Kepler</code> here!<h2 id=kani>Kani</h2><p>What if my device function emits PTX with lots of panics? Ideally I'd like to refactor it so that the Rust compiler writes fewer panics into the code.<p>I'm experimenting with the model-checker <a href=https://github.com/model-checking/kani><code>kani</code></a>.<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> https://github.com/model-checking/kani/blob/2df67e380a42a78748b8e84dcc699b0378b287c7/README.md?plain=1#L30
</span><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">my_crate<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>function_under_test<span class="z-punctuation z-separator z-rust">,</span> meets_specification<span class="z-punctuation z-separator z-rust">,</span> precondition</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">kani</span>::<span class="z-variable z-annotation z-rust">proof</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">check_my_property</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
   <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Create a nondeterministic input
</span>   <span class="z-storage z-type z-rust">let</span> input <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">kani<span class="z-punctuation z-accessor z-rust">::</span></span>any<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

   <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Constrain it according to the function's precondition
</span>   <span class="z-meta z-path z-rust">kani<span class="z-punctuation z-accessor z-rust">::</span></span>assume<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-function z-rust">precondition</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>input</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

   <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Call the function under verification
</span>   <span class="z-storage z-type z-rust">let</span> output <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">function_under_test</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>input</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

   <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Check that it meets the specification
</span>   <span class="z-support z-macro z-rust">assert!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-function z-rust">meets_specification</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>input<span class="z-punctuation z-separator z-rust">,</span> output</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>Here we <code>assert!</code> that <code>any</code> <code>input</code> to the <code>function_under_test</code> which meets the <code>precondition</code> produces <code>output</code> that <code>meets_specification</code>. It does so by converting the problem to a boolean SAT formula (<a href=https://github.com/ariasanovsky/had-to-sat>SAT solvers are fun!</a>) and trying to write a proof. We encode <code>input</code> and <code>output</code> by assigning each bit a boolean variable. The SAT formula asserts that there exists an <code>input</code> whose <code>output</code> does not meet specifications. Many thousands of dummy variables are introduced to calculate <code>output</code> from <code>input</code> through <code>function_under_test</code>.<p>When given a boolean formula in CNF, a SAT solver either produces:<ul><li><code>a witness</code>: a truth assignment that satisfies the formula (equivalently, a model) <ul><li>here, a counterexample to the proof: the underlying bits for <code>input</code> that fails the assertion;<li>(!) save this to write a failing unit test; or</ul><li><code>a certificate</code>: a step-by-step walkthrough of the binary search space that proves insatisfiability <ul><li>this can be saved for reuse</ul></ul><p>Will this meet my needs? It certainly has me interested.<h2 id=next-steps>Next steps</h2><ul><li>finish the PR<li>investigate panic-free <code>no_std</code> refactoring with <code>kani</code><li>investigate <code>abi_ptx</code> development<li>apply to other crates<li>potential features: <ul><li>build scripts to build PTX before runtime<li>specify more command arguments<li>improve compatibility<li>compile standalone kernel code (uses <code>rustc</code>, not <code>cargo</code>)<li>macros to build kernels from device functions</ul></ul></section></article></main></div><footer><section><nav><span classname=desktop-only>Made by <a rel="noopener noreferrer" href=https://syedzayyan.com/ target=_blank>SZM</a> and powered by <a rel="noopener noreferrer" href=https://getzola.org/ target=_blank>Zola</a></span></nav></section><script src=https://riasanovsky.me/js/main.js></script></footer>